name: CI (R2 Cache)

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/ci-r2.yml'

env:
  R2_BUCKET: nix-cache
  NIX_CACHE_PUBLIC_KEY: "food-ci-cache:2eICaC37vEBexPk98J0dRt5FzSX7f6hx0vRl9tPaUuM="

jobs:
  check-and-test:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Determinate Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Free up disk space
      run: |
        # Remove unnecessary software to free up space
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        df -h

    - name: Configure Nix daemon for R2 cache with post-build hook
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        NIX_SECRET_KEY: ${{ secrets.NIX_CACHE_PRIVATE_KEY }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      run: |
        R2_ENDPOINT="${CLOUDFLARE_ACCOUNT_ID}.r2.cloudflarestorage.com"
        # Create AWS credentials file for the daemon (runs as root)
        sudo mkdir -p /root/.aws
        sudo tee /root/.aws/credentials > /dev/null << EOF
        [default]
        aws_access_key_id = ${AWS_ACCESS_KEY_ID}
        aws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}
        EOF
        sudo chmod 600 /root/.aws/credentials

        # Create the signing key file (readable by all since nix copy runs as runner user)
        sudo tee /etc/nix/cache-priv-key.pem > /dev/null << EOF
        ${NIX_SECRET_KEY}
        EOF
        sudo chmod 644 /etc/nix/cache-priv-key.pem

        # Create the post-build hook script
        # This script is called after EVERY derivation is built (not substituted)
        # It receives OUT_PATHS (space-separated list of output paths)
        # We embed AWS credentials directly since the daemon runs in a different environment
        # Using printf to avoid heredoc indentation issues (shebang must start at column 0)
        printf '%s\n' \
          '#!/bin/bash' \
          'set -eu' \
          'set -o pipefail' \
          '' \
          "export AWS_ACCESS_KEY_ID=\"${AWS_ACCESS_KEY_ID}\"" \
          "export AWS_SECRET_ACCESS_KEY=\"${AWS_SECRET_ACCESS_KEY}\"" \
          '' \
          'echo "Uploading paths to R2 cache: $OUT_PATHS"' \
          "exec /nix/var/nix/profiles/default/bin/nix copy --to \"s3://${{ env.R2_BUCKET }}?endpoint=${R2_ENDPOINT}&secret-key=/etc/nix/cache-priv-key.pem&compression=zstd\" \$OUT_PATHS" \
          | sudo tee /etc/nix/post-build-hook.sh > /dev/null
        sudo chmod +x /etc/nix/post-build-hook.sh

        # Configure nix with substituter and post-build-hook
        # Determinate Nix uses nix.custom.conf for user customizations (it rewrites nix.conf on restart)
        S3_SUBSTITUTER="s3://${{ env.R2_BUCKET }}?endpoint=${R2_ENDPOINT}"
        sudo tee /etc/nix/nix.custom.conf > /dev/null << EOF
        # R2 cache configuration
        extra-substituters = ${S3_SUBSTITUTER}
        extra-trusted-public-keys = ${{ env.NIX_CACHE_PUBLIC_KEY }}

        # Post-build hook uploads every built derivation to R2
        # This includes intermediate derivations like cargo dependency caches
        post-build-hook = /etc/nix/post-build-hook.sh
        EOF

        # Restart nix-daemon to pick up new configuration
        sudo systemctl restart nix-daemon

        echo "=== Nix configuration ==="
        cat /etc/nix/nix.conf
        echo ""
        echo "=== nix.custom.conf ==="
        cat /etc/nix/nix.custom.conf
        echo ""
        echo "=== Post-build hook ==="
        cat /etc/nix/post-build-hook.sh
        echo ""
        echo "=== Hook file details ==="
        ls -la /etc/nix/post-build-hook.sh
        file /etc/nix/post-build-hook.sh
        head -c 50 /etc/nix/post-build-hook.sh | xxd
        echo ""
        echo "=== Test hook script directly ==="
        OUT_PATHS="/nix/store/test" /etc/nix/post-build-hook.sh || echo "Hook test failed with exit code: $?"

    - name: Test R2 upload manually
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      run: |
        R2_ENDPOINT="${CLOUDFLARE_ACCOUNT_ID}.r2.cloudflarestorage.com"
        # Build a small test derivation and upload it manually to verify credentials work
        TEST_PATH=$(nix build --no-link --print-out-paths --impure --expr '
          let pkgs = import <nixpkgs> {};
          in pkgs.runCommand "test-r2-upload-${toString builtins.currentTime}" {} "echo test > $out"
        ')
        echo "Built test derivation: $TEST_PATH"
        echo "Uploading to R2..."
        nix copy --to "s3://${{ env.R2_BUCKET }}?endpoint=${R2_ENDPOINT}&secret-key=/etc/nix/cache-priv-key.pem&compression=zstd" "$TEST_PATH"
        echo "Manual upload successful!"

    - name: Build e2e-tests package
      run: |
        # Build the e2e-tests package
        # The post-build hook automatically uploads every derivation as it's built,
        # including intermediate ones like clientArtifacts, workerArtifacts, etc.
        nix build .#e2e-tests --no-link
      timeout-minutes: 30

    - name: Check disk usage
      if: always()
      run: |
        echo "=== Disk usage ==="
        df -h
        echo ""
        echo "=== Nix store size ==="
        du -sh /nix/store || true
        echo ""
        echo "=== Nix daemon logs (last 50 lines) ==="
        sudo journalctl -u nix-daemon --no-pager -n 50 || true

    - name: Run e2e tests
      run: |
        # This also builds the app wrapper and its runtime deps (wrangler, geckodriver, website)
        # The post-build hook will upload those as well
        nix run .#e2e-tests
      timeout-minutes: 20
