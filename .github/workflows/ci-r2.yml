name: CI (R2 Cache)

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/ci-r2.yml'

env:
  R2_BUCKET: nix-cache
  NIX_CACHE_PUBLIC_KEY: "food-ci-cache:2eICaC37vEBexPk98J0dRt5FzSX7f6hx0vRl9tPaUuM="

jobs:
  check-and-test:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Determinate Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Free up disk space
      run: |
        # Remove unnecessary software to free up space
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        df -h

    - name: Configure Nix daemon for R2 cache with post-build hook
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        NIX_SECRET_KEY: ${{ secrets.NIX_CACHE_PRIVATE_KEY }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      run: |
        R2_ENDPOINT="${CLOUDFLARE_ACCOUNT_ID}.r2.cloudflarestorage.com"
        # Create AWS credentials file for the daemon (runs as root)
        sudo mkdir -p /root/.aws
        sudo tee /root/.aws/credentials > /dev/null << EOF
        [default]
        aws_access_key_id = ${AWS_ACCESS_KEY_ID}
        aws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}
        EOF
        sudo chmod 600 /root/.aws/credentials

        # Create the signing key file
        sudo tee /etc/nix/cache-priv-key.pem > /dev/null << EOF
        ${NIX_SECRET_KEY}
        EOF
        sudo chmod 600 /etc/nix/cache-priv-key.pem

        # Create the post-build hook script
        # This script is called after EVERY derivation is built (not substituted)
        # It receives OUT_PATHS (space-separated list of output paths)
        # Note: Using heredoc without quotes to expand variables directly into the script
        # We embed AWS credentials directly since the daemon runs in a different environment
        sudo tee /etc/nix/post-build-hook.sh > /dev/null << HOOK_EOF
        #!/bin/bash
        set -eu
        set -o pipefail

        # Set AWS credentials for R2 access
        export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
        export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"

        # OUT_PATHS contains space-separated store paths that were just built
        # Upload each path to the R2 cache
        echo "Uploading paths to R2 cache: \$OUT_PATHS"
        exec nix copy --to "s3://${{ env.R2_BUCKET }}?endpoint=${R2_ENDPOINT}&secret-key=/etc/nix/cache-priv-key.pem&compression=zstd" \$OUT_PATHS
        HOOK_EOF
        sudo chmod +x /etc/nix/post-build-hook.sh

        # Configure nix with substituter and post-build-hook
        S3_SUBSTITUTER="s3://${{ env.R2_BUCKET }}?endpoint=${R2_ENDPOINT}"
        sudo tee -a /etc/nix/nix.conf > /dev/null << EOF

        # R2 cache configuration
        extra-substituters = ${S3_SUBSTITUTER}
        extra-trusted-public-keys = ${{ env.NIX_CACHE_PUBLIC_KEY }}

        # Post-build hook uploads every built derivation to R2
        # This includes intermediate derivations like cargo dependency caches
        post-build-hook = /etc/nix/post-build-hook.sh
        EOF

        # Restart nix-daemon to pick up new configuration
        sudo systemctl restart nix-daemon

        echo "=== Nix configuration ==="
        cat /etc/nix/nix.conf
        echo ""
        echo "=== Post-build hook ==="
        cat /etc/nix/post-build-hook.sh

    - name: Test R2 upload manually
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      run: |
        R2_ENDPOINT="${CLOUDFLARE_ACCOUNT_ID}.r2.cloudflarestorage.com"
        # Build a small test derivation and upload it manually to verify credentials work
        TEST_PATH=$(nix build --no-link --print-out-paths --impure --expr '
          let pkgs = import <nixpkgs> {};
          in pkgs.runCommand "test-r2-upload-${toString builtins.currentTime}" {} "echo test > $out"
        ')
        echo "Built test derivation: $TEST_PATH"
        echo "Uploading to R2..."
        nix copy --to "s3://${{ env.R2_BUCKET }}?endpoint=${R2_ENDPOINT}&secret-key=/etc/nix/cache-priv-key.pem&compression=zstd" "$TEST_PATH"
        echo "Manual upload successful!"

    - name: Build e2e-tests package
      run: |
        # Build the e2e-tests package
        # The post-build hook automatically uploads every derivation as it's built,
        # including intermediate ones like clientArtifacts, workerArtifacts, etc.
        nix build .#e2e-tests --no-link
      timeout-minutes: 30

    - name: Check daemon logs for hook errors
      if: always()
      run: |
        echo "=== Nix daemon logs (last 100 lines) ==="
        sudo journalctl -u nix-daemon --no-pager -n 100 || true

    - name: Run e2e tests
      run: |
        # This also builds the app wrapper and its runtime deps (wrangler, geckodriver, website)
        # The post-build hook will upload those as well
        nix run .#e2e-tests
      timeout-minutes: 20
