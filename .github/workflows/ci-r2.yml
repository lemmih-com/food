name: CI (R2 Cache)

on:
  workflow_dispatch:

env:
  R2_BUCKET: nix-cache
  NIX_CACHE_PUBLIC_KEY: "food-ci-cache:2eICaC37vEBexPk98J0dRt5FzSX7f6hx0vRl9tPaUuM="

jobs:
  check-and-test:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Determinate Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Free up disk space
      run: |
        # Remove unnecessary software to free up space
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        df -h

    - name: Configure Nix daemon for R2 cache with post-build hook
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        NIX_SECRET_KEY: ${{ secrets.NIX_CACHE_PRIVATE_KEY }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      run: |
        R2_ENDPOINT="${CLOUDFLARE_ACCOUNT_ID}.r2.cloudflarestorage.com"
        # Create AWS credentials file for the daemon (runs as root)
        sudo mkdir -p /root/.aws
        sudo tee /root/.aws/credentials > /dev/null << EOF
        [default]
        aws_access_key_id = ${AWS_ACCESS_KEY_ID}
        aws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}
        EOF
        sudo chmod 600 /root/.aws/credentials

        # Create the signing key file
        sudo tee /etc/nix/cache-priv-key.pem > /dev/null << EOF
        ${NIX_SECRET_KEY}
        EOF
        sudo chmod 600 /etc/nix/cache-priv-key.pem

        # Create the post-build hook script
        # This script is called after EVERY derivation is built (not substituted)
        # It receives OUT_PATHS (space-separated list of output paths)
        S3_STORE="s3://${{ env.R2_BUCKET }}?endpoint=${R2_ENDPOINT}&secret-key=/etc/nix/cache-priv-key.pem&compression=zstd"
        sudo tee /etc/nix/post-build-hook.sh > /dev/null << 'HOOK_EOF'
        #!/bin/bash
        set -eu
        set -o pipefail

        # OUT_PATHS contains space-separated store paths that were just built
        # Upload each path to the R2 cache
        echo "Uploading paths to R2 cache: $OUT_PATHS"
        exec nix copy --to "S3_STORE_PLACEHOLDER" $OUT_PATHS
        HOOK_EOF

        # Replace placeholder with actual store URL (contains special chars)
        sudo sed -i "s|S3_STORE_PLACEHOLDER|${S3_STORE}|g" /etc/nix/post-build-hook.sh
        sudo chmod +x /etc/nix/post-build-hook.sh

        # Configure nix with substituter and post-build-hook
        S3_SUBSTITUTER="s3://${{ env.R2_BUCKET }}?endpoint=${R2_ENDPOINT}"
        sudo tee -a /etc/nix/nix.conf > /dev/null << EOF

        # R2 cache configuration
        extra-substituters = ${S3_SUBSTITUTER}
        extra-trusted-public-keys = ${{ env.NIX_CACHE_PUBLIC_KEY }}

        # Post-build hook uploads every built derivation to R2
        # This includes intermediate derivations like cargo dependency caches
        post-build-hook = /etc/nix/post-build-hook.sh
        EOF

        # Restart nix-daemon to pick up new configuration
        sudo systemctl restart nix-daemon

        echo "=== Nix configuration ==="
        cat /etc/nix/nix.conf
        echo ""
        echo "=== Post-build hook ==="
        cat /etc/nix/post-build-hook.sh

    - name: Build and cache all derivations
      run: |
        # Build the e2e-tests package
        # The post-build hook automatically uploads every derivation as it's built,
        # including intermediate ones like clientArtifacts, workerArtifacts, etc.
        nix build .#e2e-tests --no-link --print-out-paths

        # Also build the app wrapper which includes runtime deps (wrangler, geckodriver, website)
        APP_PROGRAM=$(nix eval --raw ".#apps.x86_64-linux.e2e-tests.program")
        APP_STORE_PATH=$(dirname "$(dirname "$APP_PROGRAM")")
        echo "Building app wrapper: $APP_STORE_PATH"
        nix-store --realise "$APP_STORE_PATH"

        echo "All derivations built and uploaded to R2 cache!"
      timeout-minutes: 30

    - name: Run e2e tests
      run: nix run .#e2e-tests
      timeout-minutes: 20
