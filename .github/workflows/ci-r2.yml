name: CI (R2 Cache)

on:
  workflow_dispatch:

env:
  R2_BUCKET: nix-cache
  NIX_CACHE_PUBLIC_KEY: "food-ci-cache:2eICaC37vEBexPk98J0dRt5FzSX7f6hx0vRl9tPaUuM="

jobs:
  check-and-test:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Determinate Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Configure Nix daemon for R2 cache with post-build hook
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        NIX_SECRET_KEY: ${{ secrets.NIX_CACHE_PRIVATE_KEY }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      run: |
        R2_ENDPOINT="${CLOUDFLARE_ACCOUNT_ID}.r2.cloudflarestorage.com"

        # Create the signing key file (readable by all since nix copy runs as runner user)
        sudo tee /etc/nix/cache-priv-key.pem > /dev/null <<< "${NIX_SECRET_KEY}"
        sudo chmod 644 /etc/nix/cache-priv-key.pem

        # Create the post-build hook script
        # This script is called after EVERY derivation is built (not substituted)
        # It receives OUT_PATHS (space-separated list of output paths)
        # Note: Must use full path to nix since PATH is not set in hook environment
        printf '%s\n' \
          '#!/bin/bash' \
          'set -eu' \
          'set -o pipefail' \
          '' \
          "export AWS_ACCESS_KEY_ID=\"${AWS_ACCESS_KEY_ID}\"" \
          "export AWS_SECRET_ACCESS_KEY=\"${AWS_SECRET_ACCESS_KEY}\"" \
          '' \
          'echo "Uploading to R2: $OUT_PATHS"' \
          "exec /nix/var/nix/profiles/default/bin/nix copy --to \"s3://${{ env.R2_BUCKET }}?endpoint=${R2_ENDPOINT}&secret-key=/etc/nix/cache-priv-key.pem&compression=zstd\" \$OUT_PATHS" \
          | sudo tee /etc/nix/post-build-hook.sh > /dev/null
        sudo chmod +x /etc/nix/post-build-hook.sh

        # Configure nix with substituter and post-build-hook
        # Determinate Nix uses nix.custom.conf for user customizations (it rewrites nix.conf on restart)
        sudo tee /etc/nix/nix.custom.conf > /dev/null << EOF
        extra-substituters = s3://${{ env.R2_BUCKET }}?endpoint=${R2_ENDPOINT}
        extra-trusted-public-keys = ${{ env.NIX_CACHE_PUBLIC_KEY }}
        post-build-hook = /etc/nix/post-build-hook.sh
        EOF

        # Restart nix-daemon to pick up new configuration
        sudo systemctl restart nix-daemon

    - name: Build e2e-tests package
      run: nix build .#e2e-tests --no-link
      timeout-minutes: 30

    - name: Run e2e tests
      run: nix run .#e2e-tests
      timeout-minutes: 20
