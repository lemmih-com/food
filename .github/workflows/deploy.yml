name: CD

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-24.04
    name: Deploy to CloudFlare Workers
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Determinate Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Configure Nix S3 cache
      uses: lemmih/nix-s3-cache-action@v1
      with:
        s3-endpoint: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com
        bucket: nix-cache
        aws-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        public-key: "food-ci-cache:2eICaC37vEBexPk98J0dRt5FzSX7f6hx0vRl9tPaUuM="
        private-key: ${{ secrets.NIX_CACHE_PRIVATE_KEY }}

    - name: Free up disk space
      run: |
        # Remove unnecessary software to free up space
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        df -h

    - name: Build website
      run: nix build .#website -o .wrangler/dist
      timeout-minutes: 30

    - name: Apply D1 migrations
      uses: cloudflare/wrangler-action@v3
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        command: d1 migrations apply food-lemmih-com-ingredients --remote

    - name: Deploy to CloudFlare
      uses: cloudflare/wrangler-action@v3
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        command: deploy
