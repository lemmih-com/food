name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-preview:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Determinate Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Configure Nix cache
      uses: DeterminateSystems/magic-nix-cache-action@main

    - name: Free up disk space
      run: |
        # Remove unnecessary software to free up space
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        df -h

    - name: Build website
      run: nix build .#website --no-link -o result
      timeout-minutes: 30

    - name: Get content hash
      id: content-hash
      run: |
        HASH=$(cat result/assets/content-hash.txt)
        echo "hash=$HASH" >> $GITHUB_OUTPUT
        echo "Content hash: $HASH"

    - name: Check for existing deployment
      id: check-deployment
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      run: |
        # Generate deployment name from PR number
        DEPLOYMENT_NAME="food-pr-${{ github.event.pull_request.number }}"
        echo "deployment_name=$DEPLOYMENT_NAME" >> $GITHUB_OUTPUT

        # Try to get existing deployment hash
        EXISTING_HASH=""
        PREVIEW_URL="https://$DEPLOYMENT_NAME.lemmih.workers.dev"

        # Check if deployment exists by trying to fetch the hash file
        HASH_FILE=$(mktemp)
        HTTP_CODE=$(curl -s -o "$HASH_FILE" -w "%{http_code}" "$PREVIEW_URL/content-hash.txt" || echo "000")

        if [ "$HTTP_CODE" = "200" ]; then
          EXISTING_HASH=$(cat "$HASH_FILE")
          echo "existing_hash=$EXISTING_HASH" >> $GITHUB_OUTPUT
          echo "Existing deployment found with hash: $EXISTING_HASH"
        else
          echo "existing_hash=" >> $GITHUB_OUTPUT
          echo "No existing deployment found"
        fi
        rm -f "$HASH_FILE"

        # Determine if we need to deploy
        if [ "$EXISTING_HASH" = "${{ steps.content-hash.outputs.hash }}" ]; then
          echo "needs_deploy=false" >> $GITHUB_OUTPUT
          echo "Website content unchanged, skipping deployment"
        else
          echo "needs_deploy=true" >> $GITHUB_OUTPUT
          echo "Website content changed, deployment needed"
        fi

    - name: Deploy to Cloudflare Workers
      if: steps.check-deployment.outputs.needs_deploy == 'true'
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      run: |
        # Install wrangler
        npm install -g wrangler@latest

        # Get absolute path to the result directory
        RESULT_DIR="$(pwd)/result"

        # Create a temporary wrangler.toml for this deployment
        WRANGLER_CONFIG=$(mktemp)
        cat > "$WRANGLER_CONFIG" << EOF
        name = "${{ steps.check-deployment.outputs.deployment_name }}"
        main = "$RESULT_DIR/worker/worker.js"
        compatibility_date = "2024-11-23"
        workers_dev = true
        account_id = "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"

        [assets]
        directory = "$RESULT_DIR/assets"
        binding = "ASSETS"
        not_found_handling = "single-page-application"
        EOF

        # Deploy using wrangler
        wrangler deploy --config "$WRANGLER_CONFIG"
        rm -f "$WRANGLER_CONFIG"

    - name: Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          const deploymentName = '${{ steps.check-deployment.outputs.deployment_name }}';
          const previewUrl = `https://${deploymentName}.lemmih.workers.dev`;
          const contentHash = '${{ steps.content-hash.outputs.hash }}';
          const needsDeploy = '${{ steps.check-deployment.outputs.needs_deploy }}';

          // Find existing comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('Preview Deployment')
          );

          let commentBody;
          if (needsDeploy === 'true') {
            commentBody = `## ðŸš€ Preview Deployment

          Your preview deployment is ready!

          - **Preview URL**: ${previewUrl}
          - **Content Hash**: \`${contentHash}\`
          - **Deployment**: \`${deploymentName}\`

          The preview will be updated automatically when you push new changes.`;
          } else {
            commentBody = `## âœ… Preview Deployment (Unchanged)

          Your preview deployment is still up to date!

          - **Preview URL**: ${previewUrl}
          - **Content Hash**: \`${contentHash}\`
          - **Deployment**: \`${deploymentName}\`

          No changes detected in client, server, or assets.`;
          }

          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody,
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody,
            });
          }
