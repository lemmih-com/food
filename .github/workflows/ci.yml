name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  R2_BUCKET: nix-cache
  NIX_CACHE_PUBLIC_KEY: "food-ci-cache:2eICaC37vEBexPk98J0dRt5FzSX7f6hx0vRl9tPaUuM="

jobs:
  check-and-test:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Determinate Nix
      uses: DeterminateSystems/nix-installer-action@main

    - name: Configure Nix S3 cache
      uses: lemmih/nix-s3-cache-action@v1
      with:
        s3-endpoint: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com
        bucket: ${{ env.R2_BUCKET }}
        aws-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        public-key: ${{ env.NIX_CACHE_PUBLIC_KEY }}
        private-key: ${{ secrets.NIX_CACHE_PRIVATE_KEY }}

    - name: Run flake checks
      run: nix flake check
      timeout-minutes: 30

    - name: Build e2e-tests package
      run: nix build .#e2e-tests --no-link
      timeout-minutes: 30

    - name: Run e2e tests
      run: nix run .#e2e-tests
      timeout-minutes: 20

    - name: Build website
      if: github.ref == 'refs/heads/main'
      run: nix build .#website -o website-dist
      timeout-minutes: 30

    - name: Upload website artifact
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: website
        path: website-dist/
