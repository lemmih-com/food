name = "food-lemmih-com"
main = ".wrangler/dist/worker/worker.js"
compatibility_date = "2024-11-23"
workers_dev = true

[[routes]]
pattern = "food.lemmih.com"
custom_domain = true

[build]
command = "nix build .#website -o .wrangler/dist"

[assets]
directory = ".wrangler/dist/assets"
binding = "ASSETS"
not_found_handling = "single-page-application"

# Secrets (set via `wrangler secret put ADMIN_PIN`)
# ADMIN_PIN: 4-digit PIN for administrator access

# KV namespace for storing auth tokens
[[kv_namespaces]]
binding = "AUTH_TOKENS"
id = "b87da615ba57410bac1bb18b7440d388"

# D1 database for ingredients storage
[[d1_databases]]
binding = "INGREDIENTS_DB"
database_name = "food-lemmih-com-ingredients"
database_id = "placeholder-create-with-wrangler-d1-create"
migrations_dir = "migrations"

[env.e2e]
main = "result/worker/worker.js"

[env.e2e.assets]
directory = "result/assets"
binding = "ASSETS"
not_found_handling = "single-page-application"

# KV namespace for e2e tests (local KV in dev mode)
[[env.e2e.kv_namespaces]]
binding = "AUTH_TOKENS"
id = "e2e-auth-tokens"

# D1 database for e2e tests (local)
[[env.e2e.d1_databases]]
binding = "INGREDIENTS_DB"
database_name = "food-lemmih-com-ingredients-e2e"
database_id = "e2e-ingredients-db"
migrations_dir = "migrations"

# For local dev/e2e, ADMIN_PIN can be set via vars
[env.e2e.vars]
ADMIN_PIN = "1234"

[env.preview]
main = "result/worker/worker.js"
workers_dev = true
routes = []

[env.preview.assets]
directory = "result/assets"
binding = "ASSETS"
not_found_handling = "single-page-application"

# KV namespace for preview deployments (same as production)
[[env.preview.kv_namespaces]]
binding = "AUTH_TOKENS"
id = "b87da615ba57410bac1bb18b7440d388"

# D1 database for preview deployments (same as production)
[[env.preview.d1_databases]]
binding = "INGREDIENTS_DB"
database_name = "food-lemmih-com-ingredients"
database_id = "placeholder-create-with-wrangler-d1-create"
migrations_dir = "migrations"
